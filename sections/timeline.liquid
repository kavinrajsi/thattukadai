{% comment %}
  sections/timeline.liquid
  A horizontal “timeline” with year buttons, slides, prev/next, drag/swipe.
{% endcomment %}

<section
  id="tl-{{ section.id }}"
  class="tl timeline"
  aria-label="{{ section.settings.aria_label | default: 'Product history timeline' }}"
>
  <div class="timeline__inner page-width">
    {% if section.settings.heading != blank %}
      <h2 class="timeline__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="timeline__years" role="tablist">
      {% for block in section.blocks %}
        <button
          class="tl-year{% if forloop.first %} is-active{% endif %}"
          role="tab"
          data-index="{{ forloop.index0 }}"
          {{ block.shopify_attributes }}
        >
          {{ block.settings.year }}
        </button>
      {% endfor %}
    </div>

    <div class="timeline__viewport" aria-live="polite">
      <div class="tl-track">
        {% for block in section.blocks %}
          <section class="tl-slide" data-year="{{ block.settings.year }}" {{ block.shopify_attributes }}>
            <div class="tl-card">
              {% if block.settings.image != blank %}
                {%- assign img = block.settings.image -%}
                <img
                  srcset="{{ img | img_url: '360x' }} 360w, {{ img | img_url: '720x' }} 720w, {{ img | img_url: '1080x' }} 1080w"
                  sizes="(min-width: 990px) 720px, 90vw"
                  src="{{ img | img_url: '720x' }}"
                  alt="{{ block.settings.image_alt | escape }}"
                  loading="lazy"
                >
              {% endif %}
              <div class="tl-card__content">
                {% if block.settings.title != blank %}
                  <h3 class="tl-card__title">{{ block.settings.title }}</h3>
                {% endif %}
                {% if block.settings.text != blank %}
                  <p class="tl-card__text">{{ block.settings.text }}</p>
                {% endif %}
                {% if block.settings.link_url != blank and block.settings.link_text != blank %}
                  <a class="tl-card__link" href="{{ block.settings.link_url }}">{{ block.settings.link_text }}</a>
                {% endif %}
              </div>
            </div>
          </section>
        {% endfor %}
      </div>
    </div>

    <div class="timeline__nav">
      <button class="tl-prev" aria-label="{{ 'general.pagination.previous' | t | default: 'Previous' }}">←</button>
      <button class="tl-next" aria-label="{{ 'general.pagination.next' | t | default: 'Next' }}">→</button>
    </div>
  </div>

  <style>
    #tl-{{ section.id }} .timeline{position:relative;overflow:hidden}
    #tl-{{ section.id }} .timeline__inner{position:relative}
    #tl-{{ section.id }} .timeline__heading{margin:0 0 1rem}
    #tl-{{ section.id }} .timeline__years{display:flex;gap:1rem;align-items:center;margin-bottom:1rem}
    #tl-{{ section.id }} .tl-year{background:none;border:0;font:inherit;opacity:.5;cursor:pointer;padding:.25rem .5rem}
    #tl-{{ section.id }} .tl-year.is-active{opacity:1;font-weight:700}
    #tl-{{ section.id }} .timeline__viewport{overflow:hidden}
    #tl-{{ section.id }} .tl-track{display:flex;transition:transform .45s ease;will-change:transform}
    #tl-{{ section.id }} .tl-slide{min-width:100%;padding:{{ section.settings.slide_padding }};box-sizing:border-box}
    #tl-{{ section.id }} .tl-card{display:grid;gap:1rem;align-items:center;grid-template-columns:{{ section.settings.image_first | default: true | ternary: 'min(420px, 45%) 1fr', '1fr' }}}
    #tl-{{ section.id }} img{width:100%;height:auto;display:block}
    #tl-{{ section.id }} .timeline__nav{position:absolute;right:1rem;bottom:1rem;display:flex;gap:.5rem}
    #tl-{{ section.id }} .tl-prev,#tl-{{ section.id }} .tl-next{cursor:pointer}
    /* Optional: show multiple cards per view on large screens */
    @media (min-width: 990px){
      {% if section.settings.cards_per_view > 1 %}
      #tl-{{ section.id }} .tl-slide{min-width:calc(100% / {{ section.settings.cards_per_view }})}
      #tl-{{ section.id }} .tl-card{grid-template-columns:1fr}
      {% endif %}
    }
  </style>

  <script>
    (function () {
      const root = document.getElementById('tl-{{ section.id }}');
      if (!root) return;

      const viewport = root.querySelector('.timeline__viewport');
      const track = root.querySelector('.tl-track');
      const slides = Array.from(root.querySelectorAll('.tl-slide'));
      const years = Array.from(root.querySelectorAll('.tl-year'));
      const prevBtn = root.querySelector('.tl-prev');
      const nextBtn = root.querySelector('.tl-next');

      let index = 0;
      const clamp = (n, min, max) => Math.max(min, Math.min(n, max));

      function goTo(i, { animate = true } = {}) {
        index = clamp(i, 0, slides.length - 1);
        track.style.transition = animate ? 'transform .45s ease' : 'none';
        track.style.transform = `translateX(-${index * 100}%)`;
        years.forEach((y, k) => {
          y.classList.toggle('is-active', k === index);
          y.setAttribute('aria-selected', k === index);
        });
        prevBtn.disabled = index === 0;
        nextBtn.disabled = index === slides.length - 1;
      }

      // Buttons
      prevBtn.addEventListener('click', () => goTo(index - 1));
      nextBtn.addEventListener('click', () => goTo(index + 1));

      // Click a year
      years.forEach((btn) => btn.addEventListener('click', () => goTo(+btn.dataset.index)));

      // Keyboard
      root.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') goTo(index + 1);
        if (e.key === 'ArrowLeft') goTo(index - 1);
      });

      // Drag / swipe
      let startX = 0,
        curX = 0,
        dragging = false,
        startIndex = 0;
      const start = (x) => {
        dragging = true;
        startX = curX = x;
        startIndex = index;
        track.style.transition = 'none';
      };
      const move = (x) => {
        if (!dragging) return;
        curX = x;
        const dx = curX - startX;
        const pct = (dx / viewport.clientWidth) * 100;
        track.style.transform = `translateX(calc(-${startIndex * 100}% + ${-pct}%))`;
      };
      const end = () => {
        if (!dragging) return;
        dragging = false;
        const dx = curX - startX;
        const threshold = viewport.clientWidth * 0.2;
        if (dx < -threshold) goTo(startIndex + 1);
        else if (dx > threshold) goTo(startIndex - 1);
        else goTo(startIndex);
      };

      viewport.addEventListener('pointerdown', (e) => {
        viewport.setPointerCapture(e.pointerId);
        start(e.clientX);
      });
      viewport.addEventListener('pointermove', (e) => move(e.clientX));
      viewport.addEventListener('pointerup', end);
      viewport.addEventListener('pointercancel', end);
      viewport.addEventListener('pointerleave', end);

      // Initial state
      goTo(0, { animate: false });
    })();
  </script>

  {% schema %}
{
  "name": "Timeline Carousel",
  "tag": "section",
  "class": "section-timeline",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Our Story" },
    { "type": "text", "id": "aria_label", "label": "ARIA label", "default": "Product history timeline" },
    {
      "type": "range",
      "id": "cards_per_view",
      "label": "Cards per view (desktop)",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 1
    },
    { "type": "text", "id": "slide_padding", "label": "Slide padding (CSS)", "default": "1rem" },
    { "type": "checkbox", "id": "image_first", "label": "Image left (single-card layout)", "default": true }
  ],
  "blocks": [
    {
      "type": "entry",
      "name": "Year slide",
      "settings": [
        { "type": "text", "id": "year", "label": "Year", "default": "1970" },
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "image_alt", "label": "Image alt text" },
        { "type": "text", "id": "title", "label": "Title", "default": "Title" },
        { "type": "richtext", "id": "text", "label": "Text", "default": "<p>Short description.</p>" },
        { "type": "url", "id": "link_url", "label": "Link URL" },
        { "type": "text", "id": "link_text", "label": "Link text", "default": "Learn more" }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "Timeline Carousel",
      "category": "Image"
    }
  ]
}
  {% endschema %}
</section>

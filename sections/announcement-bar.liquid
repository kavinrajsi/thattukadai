{% comment %}
  ANNOUNCEMENT BAR (Multi-instance)
  ------------------------------------------------------------------
  PURPOSE:
  - Displays one or more announcement bars on the site (stacked vertically if multiple).
  - Each bar can:
      - Have its own message, colors, scroll effect, and dismiss button.
      - Be shown only on the homepage or across the site.
      - Be displayed only between specific dates.
      - Remember dismissals via session cookies (no expiry date set).
{% endcomment %}

{% assign today = 'now' | date: '%Y-%m-%d' %}
{% assign has_active_announcement = false %}

{%- for block in section.blocks -%}
  {%- if block.settings.showOnlyOnHome and request.page_type != 'index' -%}
    {%- continue -%}
  {%- endif -%}

  {%- assign start = block.settings.startDate | default: '' -%}
  {%- assign end = block.settings.endDate | default: '' -%}
  {%- if start != '' and today < start -%}{%- continue -%}{%- endif -%}
  {%- if end != '' and today > end -%}{%- continue -%}{%- endif -%}

  {% assign has_active_announcement = true %}
  {%- break -%}
{%- endfor -%}

{% if section.settings.enableAnnouncement and has_active_announcement %}
  <div class="announcement-bars" style="--ab-gap: {{ section.settings.stackGap }}px;">
    {% assign today = 'now' | date: '%Y-%m-%d' %}

    {% for block in section.blocks %}
      {% if block.settings.showOnlyOnHome and request.page_type != 'index' %}
        {% continue %}
      {% endif %}

      {% assign start = block.settings.startDate | default: '' %}
      {% assign end = block.settings.endDate | default: '' %}
      {% if start != '' and today < start %}{% continue %}{% endif %}
      {% if end != '' and today > end %}{% continue %}{% endif %}

      {% assign key = 'announcement_bar_' | append: section.id | append: '_' | append: block.id %}

      <!-- Announcement Bar -->
      <div
        class="announcement-bar"
        role="region"
        aria-label="Store announcement"
        style="--ab-bg: {{ block.settings.bgColor }}; --ab-text: {{ block.settings.textColor }};"
        data-key="{{ key }}"
        data-enable-dismiss="{{ block.settings.enableDismiss }}"
        data-start-date="{{ block.settings.startDate }}"
        data-end-date="{{ block.settings.endDate }}"
        {{ block.shopify_attributes }}
      >
        <div class="announcement-bar__inner">
          {% if block.settings.useMarquee %}
            <marquee
              class="announcement-bar__marquee"
              direction="left"
              width="100%"
              scrollamount="{{ block.settings.scrollAmount | default: 10 }}"
              onmouseover="this.stop();"
              onmouseout="this.start();"
            >
              {% assign marquee_text = block.settings.message | strip_newlines | replace: '&nbsp;', ' ' %}
              <span class="announcement-bar__text">{{ marquee_text }}</span>
            </marquee>
          {% else %}
            <span class="announcement-bar__text rte">{{ block.settings.message }}</span>
          {% endif %}

          {% if block.settings.enableDismiss %}
            <button class="announcement-bar__close" type="button" aria-label="Dismiss announcement">&times;</button>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Only load announcement.js if enabled + has bars -->
  <script src="{{ 'announcement.js' | asset_url }}" defer></script>
{% endif %}

{% schema %}
{
  "name": "Announcement Bar",
  "settings": [
    {
      "type": "checkbox",
      "id": "enableAnnouncement",
      "label": "Enable announcement",
      "default": true
    },
    {
      "type": "range",
      "id": "stackGap",
      "label": "Space between bars (px)",
      "min": 0,
      "max": 24,
      "step": 2,
      "default": 8
    }
  ],
  "blocks": [
    {
      "type": "bar",
      "name": "Announcement bar",
      "settings": [
        {
          "type": "richtext",
          "id": "message",
          "label": "Message text",
          "default": "<ul><li>Free shipping over $50</li><li>30-day returns</li></ul>"
        },
        { "type": "checkbox", "id": "useMarquee", "label": "Scroll (marquee)", "default": true },
        {
          "type": "range",
          "id": "scrollAmount",
          "label": "Scroll speed",
          "min": 1,
          "max": 20,
          "step": 1,
          "default": 10
        },
        { "type": "color", "id": "bgColor", "label": "Background color", "default": "#111827" },
        { "type": "color", "id": "textColor", "label": "Text color", "default": "#ffffff" },
        { "type": "checkbox", "id": "enableDismiss", "label": "Allow dismiss", "default": true },
        { "type": "text", "id": "startDate", "label": "Show from date (YYYY-MM-DD)" },
        { "type": "text", "id": "endDate", "label": "Show until date (YYYY-MM-DD)" },
        { "type": "checkbox", "id": "showOnlyOnHome", "label": "Show only on homepage", "default": false }
      ]
    }
  ],
  "max_blocks": 12
}
{% endschema %}

{% stylesheet %}
  /* Container for all stacked announcement bars */
  .announcement-bars {
    gap: var(--ab-gap, 8px); /* Controlled by section setting */
  }

  /* Single announcement bar styling */
  .announcement-bar {
    background: var(--ab-bg, #f6ca30);
    color: var(--ab-text, #161a1d);
  }

  /* Inner container: centers content & applies padding */
  .announcement-bar__inner {
    max-width: var(--page-width, 100%);
  }
{% endstylesheet %}
